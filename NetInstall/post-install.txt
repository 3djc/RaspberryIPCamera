read -p "waiting"
set -o verbose
## Set up pi user
chroot /rootfs useradd pi 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs echo 'pi:raspberry' | chroot /rootfs chpasswd 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs usermod -a -G sudo pi 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs mkdir /home/pi 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs cp /root/.profile /home/pi/.profile 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs cp /root/.bashrc /home/pi/.bashrc 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs sed -i 's/pi:x:1000:1000::\/home\/pi:\/bin\/sh/pi:x:1000:1000::\/home\/pi:\/bin\/bash/g' /etc/passwd 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs sed -i 's/# export LS_OPTIONS=/export LS_OPTIONS=/g' /home/pi/.bashrc 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs sed -i 's/# eval/eval/g' /home/pi/.bashrc 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs sed -i "s/# alias ls=/alias ls=/g" /home/pi/.bashrc 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs sed -i "s/# alias ll=/alias ll=/g" /home/pi/.bashrc 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs sed -i "s/# alias l=/alias l=/g" /home/pi/.bashrc 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs chown -R pi /home/pi 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs chgrp -R pi /home/pi 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs chmod -R 755 /home/pi 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs runuser -l  pi -c 'git clone https://github.com/ronnyvdbr/RaspberryIPCamera.git /home/pi/RaspberryIPCamera' 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs runuser -l  pi -c 'git clone https://github.com/mpromonet/h264_v4l2_rtspserver.git /home/pi/h264_v4l2_rtspserver' 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs usermod -a -G www-data pi 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs rm /etc/nginx/sites-enabled/default 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs cp /home/pi/RaspberryIPCamera/DefaultConfigFiles/RaspberryIPCamera.Nginx.Siteconf /etc/nginx/sites-available/RaspberryIPCamera.Nginx.Siteconf 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs ln -s /etc/nginx/sites-available/RaspberryIPCamera.Nginx.Siteconf /etc/nginx/sites-enabled/RaspberryIPCamera.Nginx.Siteconf 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs cp /home/pi/RaspberryIPCamera/DefaultConfigFiles/sudoers_commands /etc/sudoers.d/sudoers_commands 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs curl http://www.linux-projects.org/listing/uv4l_repo/lrkey.asc | chroot /rootfs apt-key add - 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs echo "deb http://www.linux-projects.org/listing/uv4l_repo/raspbian/ wheezy main" | chroot /rootfs tee -a /etc/apt/sources.list 2>&1 | chroot /rootfs tee -a /post-install.log
export DEBIAN_FRONTEND=noninteractive
chroot /rootfs apt-get update 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs apt-get -y install uv4l uv4l-raspicam 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs apt-get -y install uv4l-raspicam-extras 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs apt-get -y install uv4l-uvc 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs apt-get -y install uv4l-server 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs cp /home/pi/RaspberryIPCamera/DefaultConfigFiles/uv4l-raspicam.conf /etc/uv4l/uv4l-raspicam.conf 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs cp /home/pi/RaspberryIPCamera/DefaultConfigFiles/uv4l-server.conf /etc/uv4l/uv4l-server.conf 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs sed -i "s/--editable-config-file=\$CONFIGFILE/--editable-config-file=\/etc\/uv4l\/uv4l-server.conf/g" /etc/init.d/uv4l_raspicam 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs chgrp www-data /etc/uv4l/uv4l-raspicam.conf 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs chmod 664 /etc/uv4l/uv4l-raspicam.conf 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs cp /home/pi/RaspberryIPCamera/DefaultConfigFiles/RTSP-Server.service /etc/systemd/system/RTSP-Server.service 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs chgrp www-data /home/pi/RaspberryIPCamera/www/RaspberryIPCameraSettings.ini 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs chmod 664 /home/pi/RaspberryIPCamera/www/RaspberryIPCameraSettings.ini 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs chgrp www-data /etc/timezone 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs chmod 664 /etc/timezone 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs chgrp www-data /etc/ntp.conf 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs chmod 664 /etc/ntp.conf 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs runuser -l  pi -c 'cmake /home/pi/h264_v4l2_rtspserver && make -C /home/pi/h264_v4l2_rtspserver' 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs make -C /home/pi/h264_v4l2_rtspserver install 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs apt-get install localepurge 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs localepurge 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs apt-get remove localepurge cmake liblivemedia-dev libv4l-dev liblog4cpp5-dev 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs find /usr/share/doc -depth -type f ! -name copyright|xargs rm || true 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs find /usr/share/doc -empty|xargs rmdir || true 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs rm -rf /usr/share/man/* /usr/share/groff/* /usr/share/info/* 2>&1 | chroot /rootfs tee -a /post-install.log
chroot /rootfs rm -rf /usr/share/lintian/* /usr/share/linda/* /var/cache/man/* 2>&1 | chroot /rootfs tee -a /post-install.log
